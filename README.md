# tfsetup

`tfsetup` uses the go templating language to generate a setup.tf file for terraform projects. Its intended use to help with any policy-based or repetitive setup. You have access to standard go template functions as well as [sprig](https://masterminds.github.io/sprig/).

It requires the following:
* `tfsetup-context.json` in the current directory
* `tfsetup-config/` as a directory somewhere at or above the current directory
* `tfsetup-config/context.json`
* `tfsetup-config/setup.tmpl`

`tfsetup` Can be run with `--generate` or `--check`. In generate mode, it creates a file called `setup.tf` in the current directory containing the results of evaluating `tfsetup-config/setup.tmpl` with input containing the following fields:
* `Config` -- the data from `tfsetup-config/setup.tmpl`
* `Project` -- the data from `tfsetup-config.json`
* `Path` -- the relative path from the directory containing `tfsetup-config` to the local directory

If `tofu` or `terraform` is found in the path, `tfsetup` will run `tofu fmt` or `terraform fmt` on the resulting setup file. This is the only thing that makes this tool specific to terraform. Otherwise, it is just running the go templating system.

# New in 1.1.0

`tfsetup` will look in the current directory for any file whose names match `<something>.tfsetup.tmpl`, and will generate a file called `<something>` by evaluating the template with the same context as used for the `setup.tf` file. If the output file name ends with `.tf`, it will be formatted. If formatting fails, the output of the format command will be appended to the file in a multi-line comment.

`tfsetup` can also be run with the `--render` option. In this mode, it will read standard input as a template and render it to standard output or write an error to standard error. No formatting is applied when rendering standard input. This can be used to more easily debug templates or even to inspect context, as in `echo '{{.|toJson}}' | tfsetup --render`.

The `--min-version` option will cause `tfsetup` to fail if the version is < the minimum version. This can help prevent an old version of `tfsetup` from silently ignoring files not recognized by older versions. If you say `--min-version 1.1.0`, `1.0.x` versions will fail with a usage message.

# Example

`tfsetup-config/context.json`:
```json
{
  "accounts": {
    "acct1": "123456789012",
    "acct2": "210987654321"
  }
}
```

`tfsetup-context.json`:
```json
{
  "account": "acct1"
}
```

`tfsetup-config/setup.tmpl`:
```
{{- /* setup.tmpl is manual, but we want this comment in setup.tf */ -}}
# Generated by tfsetup

data "external" "tfgen_check_generated" {
  program = ["tfsetup", "--min-version", "1.1.0", "--check"]
}

locals {
  region         = "us-east-1"
  aws_account_id = "{{index .Config.accounts .Project.account}}"
}

terraform {
  backend "s3" {
    bucket         = "terraform-state-{{index .Config.accounts .Project.account}}"
    dynamodb_table = "terraform_locks"
    encrypt        = true
    key            = "examples/{{.Path}}/terraform.tfstate"
    region         = "us-east-1"
  }
}

provider "aws" {
  region              = local.region
  allowed_account_ids = [local.aws_account_id]
}
```

# Release Reminder

Update `Version` in main.go, then push tag.

```
version=x.y.z
git tag -s v$version -m"Release version $version"
```
